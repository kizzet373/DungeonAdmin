<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <title>Magic Items</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="content-type" content="text/html;charset=UTF-8">
  <meta http-equiv="content-language" content="en">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="/scripts/entity-page-manager.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.7/cdn.min.js" defer></script>

  <script src="/scripts/google-auth.js"></script>
  <script src="/scripts/entity-loader.js"></script>
  <script src="/scripts/global-utilities.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/theme_standard-blue.css">
</head>

<body>
  <div class="container-wrap-wrap">
    <div class="container-wrap">
      <div id="header-placeholder"></div>
      <script>
        fetch('/header.html')
          .then(res => res.text())
          .then(html => {
            document.getElementById('header-placeholder').outerHTML = html;
          })
          .catch(error => console.error('all-magic-items.html: Error loading header:', error));
      </script>
      <main class="content-wrap" role="main">
        <div class="container content">
          <div class="row">
            <div class="main-content-wrap col-md-12">
              <div class="main-content">
                <div class="page-title page-header"><span>Magic Items</span></div>
                <div class="breadcrumbs"><a href="/index">Home</a> &raquo; Magic Items</div>

                <div id="page-content" x-data="magicItemsData()" x-cloak>
                  <div x-show="!isReady" class="loading-spinner"></div>

                  <template x-if="isReady">
                    <div id="isReadyContainer">
                      <h1 id="toc1"><span>Filtered Lists</span></h1>
                      <p><a href="/content/magic-item#consumable">Consumable Magic Items</a></p>

                      <div class="tab-container">
                        <h1><span>All Magic Items</span></h1>
                        <div class="tab-divst" id="tab-divst">
                          <template x-for="(tabValue) in uniqueRarities" :key="tabValue">
                            <div class="tab-item text-capitalize" :class="{'active': activeTab === tabValue}" @click="EPManager.setFilter('rarity', tabValue)" x-text="tabValue"></div>
                          </template>
                        </div>

                        <div class="tab-content-container">
                          <template x-for="(rarity, i) in uniqueRarities" :key="rarity">
                            <div :id="rarity" class="tab-content" :class="{ 'active': activeTab === rarity }">
                              <table class="w-100 table-bordered">
                                <thead>
                                  <tr class="border-1">
                                    <th>Item Name</th>
                                    <th>Type</th>
                                    <th>Attunement</th>
                                    <th>Price</th>
                                  </tr>
                                </thead>
                                <template x-for="(magicItem, index) in filteredMagicItems.filter(item => item.rarity === rarity)" :key="magicItem.name">
                                  <tbody >
                                    <tr data-bs-toggle="collapse" :data-bs-target="`#${i}-${index}-details`" aria-expanded="false" :aria-controls="`#${i}-${index}-details`" :class="'border-1 interactive ' + (Math.floor(index) % 2 === 0 ? 'primary-row' : 'secondary-row')">
                                      <td>
                                        <a href="#" x-text="magicItem.name"></a>
                                      </td>
                                      <td x-text="magicItem.type.split(' (')[0].trim()"></td>
                                      <td x-text="magicItem.attunement"></td>
                                      <td x-text="magicItem.cost"></td>
                                    </tr>
                                    <tr :class="Math.floor(index) % 2 === 0 ? 'primary-row' : 'secondary-row'">
                                      <td colspan="4" class="p-0">
                                        <div class="collapse p-3" style="border-bottom:1px solid; white-space: pre-wrap;" :id="`${i}-${index}-details`" x-html="magicItem.description"></div>
                                      </td>
                                    </tr>
                                  </tbody>
                                </template>
                              </table>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      <footer class="footer-wrap" role="contentinfo">
        <div class="container footer">

          <div class="license-area">Unless otherwise stated, the content of this page is licensed under <a rel="license"
              href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons
              Attribution-ShareAlike 3.0 License</a></div>
        </div>
      </footer>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.addEventListener('globalEditionHandled', async (event) => {
        await loadEntity(window.currentGlobalEdition, 'magic-items');
      });
    });

    document.addEventListener('alpine:init', () => {
      Alpine.data('magicItemsData', function () {
        return {
          EPManager: null,
          allMagicItems: [],
          filteredMagicItems: [],
          uniqueRarities: ['common', 'uncommon', 'rare', 'very rare', 'legendary', 'artifact','rarity varies'],
          availableRarities: [],
          isReady: false,
          activeTab: 0,
          activeFilter: {},

          init() {
            this.EPManager = window.createEntityPageManager(
              this,
              (newActiveFilter, dataFilteredByNormalFilters, newActiveTabValue, newAvailableTabValues) => {
                this.activeFilter = { ...newActiveFilter };
                this.activeTab = newActiveTabValue;
                this.filteredMagicItems = dataFilteredByNormalFilters;
                this.availableRarities = newAvailableTabValues;
              },
              {
                tabProperty: 'rarity',
                tabValues: this.uniqueRarities
              }
            );
            this.EPManager.initialize();

            document.addEventListener('magic-itemsLoaded', (event) => {
              this.allMagicItems = window.entities["magic-items"] || [];

              if (!this.allMagicItems) {
                console.error("magic-items: magic-itemsLoaded event fired but magic-items is still empty.");
                return;
              }

              if (this.EPManager) {
                this.EPManager.setEntityData(this.allMagicItems);
                this.activeFilter = { ...this.EPManager.activeFilter };
              }

              queueMicrotask(() => {
                this.isReady = true;
              });
            });
          },
          getItemHref(item) {
            let baseName = item.name.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s/g, '-');
            if (item.source && item.source.includes('Artificer UA')) {
              baseName += '-ua';
            }
            return `/content/magic-item#${baseName}`;
          }
        };
      });
    });
  </script>
</body>

</html>