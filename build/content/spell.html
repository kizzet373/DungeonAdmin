<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <title x-text="spell ? spell.name : 'Spell Details'">Spell Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="content-type" content="text/html;charset=UTF-8">
    <meta http-equiv="content-language" content="en">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.7/cdn.min.js" defer></script>
    <script type="text/javascript" src="/scripts/google-auth.js"></script>
    <script type="text/javascript" src="/content/entities/koink-spell-list.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/theme_standard-blue.css">
    <style>
        .not-found {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>

<body id="html-body" x-data="spellData()">
    <div id="skrollr-body">
        <div class="container-wrap-wrap">
            <div class="container-wrap">

                <div id="header-placeholder"></div>
                <script>
                    fetch('/header.html')
                        .then(response => response.text())
                        .then(htmlContent => {
                            document.getElementById('header-placeholder').outerHTML = htmlContent;
                            checkAuthStatus();
                        })
                        .then(() => {
                            $('.dropdown-toggle').on('click', e => {
                                if ($(window).width() <= 768) $(e.target).next().toggleClass('open');
                            });
                        })
                </script>

                <main class="content-wrap" role="main">
                    <div class="container content">
                        <div class="row">
                            <div class="main-content-wrap col-md-12">
                                <div class="main-content">
                                    <template x-if="spell">
                                        <div>
                                            <div class="page-title page-header"><span x-text="spell.name"></span></div>
                                            <div class="breadcrumbs">
                                                <a href="/index">Home</a> &raquo; 
                                                <a href="/content/all-spells">All Spells</a> &raquo; 
                                                <span x-text="spell.name"></span>
                                            </div>
                                            <div>
                                                <p>Source: <span class="text-capitalize" x-text="spell.source || 'Core Rulebook'"></span></p>
                                                <p class="text-capitalize"><em><span x-text="spell.school"></span> <span x-text="getSpellLevel(spell.level)"></span> (<span x-text="spell.classes.join(', ')"></span>)</em></p>
                                                <p>
                                                    <strong>Casting Time: </strong><span class="spell-detail text-capitalize" x-text="spell.casting_time"></span><br>
                                                    <strong>Range: </strong><span class="spell-detail" x-text="spell.range"></span><br>
                                                    <strong>Components: </strong><span class="spell-detail" x-text="spell.components"></span><br>
                                                    <strong>Duration: </strong><span class="spell-detail" x-html="spell.duration"></span>
                                                </p>
                                                <div x-html="formatDescription(spell.description)"></div>
                                            </div>
                                        </div>
                                    </template>

                                    <template x-if="!spell && !loading">
                                        <div class="not-found">
                                            <h3>Spell Not Found</h3>
                                            <p>Sorry, the spell you're looking for couldn't be found. Please check the
                                                URL and try again.</p>
                                            <p>You can <a href="/content/all-spells">view all spells here</a>.</p>
                                        </div>
                                    </template>

                                    <template x-if="loading">
                                        <div>
                                            <p>Loading spell information...</p>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>

                <footer class="footer-wrap" role="contentinfo">
                    <div class="container footer">
                        <div class="license-area">Unless otherwise stated, the content of this page is licensed under <a
                                rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons
                                Attribution-ShareAlike 3.0 License</a></div>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <script>
        function spellData() {
            return {
                spell: null,
                loading: true,

                init() {
                    this.loadSpellFromUrl();

                    window.addEventListener('hashchange', () => {
                        this.loadSpellFromUrl();
                    });
                },

                loadSpellFromUrl() {
                    let spellName = window.location.hash.substring(1);

                    if (!spellName) {
                        this.spell = null;
                        this.loading = false;
                        return;
                    }

                    this.spell = this.findSpellByName(this.normalizeSpellName(spellName));
                    this.loading = false;

                    if (this.spell) {
                        document.title = this.spell.name;
                    }
                },

                normalizeSpellName(name) {
                    return name.toLowerCase().replace(/[^a-z0-9]/g, '')
                },

                findSpellByName(normalizedName) {
                    for (let level = 0; level < window.entities.spells.length; level++) {
                        let foundSpell = window.entities.spells[level].find(spell => this.normalizeSpellName(spell.name) === normalizedName);

                        if (foundSpell) return foundSpell;
                    }

                    return null;
                },

                getSpellLevel(level) {
                    if (level === 0) return 'Cantrip';

                    const suffixes = ['st', 'nd', 'rd'];
                    const suffix = level <= 3 ? suffixes[level - 1] : 'th';
                    return `${level}${suffix} Level`;
                },

                formatDescription(description) {
                    let formatted = description.replace(/\n([^:\n]{1,25}:)(?=\s|$)/g, '\n<strong>$1</strong>'); //wrap short headings in bold
                    formatted = "<p>" + formatted
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/\n/g, '<br>') + "</p>";

                    return formatted
                }
            };
        }
    </script>
</body>

</html>